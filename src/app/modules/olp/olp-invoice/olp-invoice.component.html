<div class="p-4">
  <!-- Summary Cards -->
  <div class="grid mb-4">
    <div *ngFor="let status of budgetStatuses" class="col-12 md:col-3">
      <div class="summary-card surface-card shadow-2 p-3 border-round text-center">
        <p-tag [value]="status" [severity]="getSeverity(status)"></p-tag>
        <h3 class="mt-2 text-3xl font-bold">{{ groupedData[status].length || 0 }}</h3>
        <!-- <p class="text-sm text-color-secondary">Budgets</p> -->
      </div>
    </div>
  </div>

  <!-- Budget Groups -->
  <div *ngFor="let status of budgetStatuses">
    <h2 class="text-xl mb-3 text-primary font-semibold border-bottom-2 pb-2 border-primary">
      {{ status }} Budgets
    </h2>

    <ng-container *ngIf="groupedData[status]?.length; else noData">
      <p-accordion [multiple]="true">
        <p-accordionTab *ngFor="let olp of groupedData[status]; let i = index"
          [header]="'OLP ID: ' + olp.olpId + ' | ' + olp.bride + ' & ' + olp.groom">
          <form [formGroup]="getOlpFormGroup(status, i)">
            <p class="text-sm mb-3 text-color-secondary">
              Comments: {{ olp.budgetComments || '—' }}
            </p>

            <ng-container [formArrayName]="'events'">
              <ng-container *ngIf="getOlpFormGroup(status, i) as olpFormGroup">
                <ng-container *ngIf="getEvents(olpFormGroup) as eventArray">
                  <div *ngFor="let eventGroup of eventArray.controls; let j = index" [formGroupName]="j"
                    class="surface-section border-round p-3 mb-3 shadow-1">
                    <div class="grid formgrid p-fluid">
                      <div class="field col-12 md:col-4">
                        <label>Event</label>
                        <input pInputText [value]="eventGroup.get('eventName')?.value?.name" disabled />
                      </div>
                      <div class="field col-12 md:col-4">
                        <label>Date</label>
                        <input pInputText [value]="eventGroup.get('eventDate')?.value" disabled />
                      </div>
                      <div class="field col-12 md:col-4">
                        <label>Location</label>
                        <input pInputText [value]="eventGroup.get('eventLocation')?.value" disabled />
                      </div>

                      <div class="field col-12 md:col-4">
                        <label>Guests</label>
                        <input type="number" pInputText [value]="eventGroup.get('eventGuests')?.value" disabled />
                      </div>

                      <div class="field col-12 md:col-4">
                        <label>Budget (₹)</label>
                        <input pInputText formControlName="eventBudget" placeholder="Enter budget" />
                        <small *ngIf="eventGroup.get('eventBudget')?.errors?.['required']" class="text-red-500">
                          Budget is required.
                        </small>
                        <small *ngIf="eventGroup.get('eventBudget')?.errors?.['min']" class="text-red-500">
                          Must be > 0.
                        </small>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </ng-container>

            <div class="flex justify-content-end mt-3">
              <p-button label="Save" icon="pi pi-save" (click)="saveBudget(status, i)" severity="success"
                styleClass="w-full md:w-auto"></p-button>
            </div>
          </form>
        </p-accordionTab>
      </p-accordion>
    </ng-container>

    <ng-template #noData>
      <div class="empty-state text-center p-4 surface-50 border-round shadow-1">
        <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" alt="No Data" width="80" class="mb-2" />
        <p class="text-secondary">No {{ status }} budgets to show</p>
      </div>
    </ng-template>
  </div>
</div>