<p-table [value]="events" dataKey="olpId" [expandedRowKeys]="expandedOlpRows">
  <ng-template pTemplate="header">
    <tr>
      <th>OLP ID</th>
      <th>Bride</th>
      <th>Groom</th>
      <th>Contact</th>
      <th>Email</th>
      <th>Status</th>
      <th>Team Status</th>
      <th>Actions</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-expanded="expanded" let-olp>
    <tr>
      <td>{{ olp.olpId }}</td>
      <td>{{ olp.bride }}</td>
      <td>{{ olp.groom }}</td>
      <td>{{ olp.contactNumber }}</td>
      <td>{{ olp.email }}</td>
      <td>{{ olp.status }}</td>
      <td>
        <span [ngClass]="olp.team === 'pending' ? 'team-pending' : 'team-assigned'">
          {{ olp.team }}
        </span>
      </td>
      <td>
        <button pButton type="button" icon="pi pi-chevron-down" class="p-button-text" [pRowToggler]="olp">
          {{ expanded ? 'Hide Events' : 'Show Events' }}
        </button>
      </td>
    </tr>
  </ng-template>

  <!-- Expanded row to show events for the selected OLP -->
  <ng-template pTemplate="rowexpansion" #expandedrow let-olp>
    <tr>
      <td colspan="8">
        <p-table [value]="olp.events" [responsive]="true" class="p-mt-3">
          <ng-template pTemplate="header">
    <tr>
      <th>Event Name</th>
      <th>Date</th>
      <th>Location</th>
      <th>Assigned Team</th>
      <th>Actions</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-event>
    <tr>
      <td>{{ event.eventName.name }}</td>
      <td>{{ event.eventDate }}</td>
      <td>{{ event.eventLocation }}</td>
      <td>
        <ng-container *ngIf="event.eventTeams.length > 0; else noTeam">
          <div class="assigned-team">
            <div *ngFor="let member of event.eventTeams" class="avatar tooltip" [ngClass]="getRoleClass(member.role)">
              {{ getInitials(member.name) }}
              <span class="tooltiptext">{{ member.name }} - {{ member.role }}</span>
            </div>
          </div>
        </ng-container>
        <ng-template #noTeam>
          <span class="p-text-secondary">No team assigned</span>
        </ng-template>
      </td>
      <td>
        <button pButton type="button" label="Assign Team" icon="pi pi-users" class="p-button-sm p-button-outlined"
          (click)="openAssignDialog(olp, event)"></button>
      </td>
    </tr>
  </ng-template>
</p-table>
</td>
</tr>
</ng-template>
</p-table>

<p-dialog header="Assign Team" [(visible)]="displayDialog" [modal]="true" [style]="{ width: '40vw' }"
  [closable]="false">
  <div class="p-fluid" *ngIf="selectedEvent">
    <div *ngFor="let role of roles" class="p-field p-mb-3">
      <label>Select {{ role }}</label>
      <p-dropdown [options]="getAvailableEmployees(role)" [(ngModel)]="selectedAssignments[role]" optionLabel="name"
        placeholder="Select {{ role }}" [filter]="true" appendTo="body" [showClear]="true"></p-dropdown>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" (click)="displayDialog = false" class="p-button-text"></button>
    <button pButton label="Save" icon="pi pi-check" (click)="assignTeam()" class="p-button-success"></button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>